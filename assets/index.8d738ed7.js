import{d as A,ab as C,_ as D}from"./index.767799dd.js";/* empty css               *//* empty css               *//* empty css               *//* empty css               */import{d as N,r as O,o as x,bQ as P,bz as R,C as V,D as $,aI as s,aH as i,G as c,aM as f,aN as m,n as b,b7 as I,bg as S,bR as T,bx as H,bB as M,bF as j}from"./arco.4840bb92.js";import{f as q}from"./vue.b2a11794.js";import{d as y,c as L,r as _,j as F,k as U,l as z,m as G}from"./serial.d615852e.js";import"./chart.2ff044ff.js";const Q={class:"container"},W={style:{display:"flex","justify-content":"space-between","align-items":"center"}},J=["innerHTML"],K={name:"Flash"},X=N({...K,setup(Y){const d=A(),e=O({status:"\u70B9\u51FB\u66F4\u65B0\u6309\u94AE\u66F4\u65B0\u56FA\u4EF6\u5230\u8BBE\u5907<br/><br/>",binaryFile:void 0,binaryName:"",protocol:"Official"}),l=q();x(async()=>{var t;if(l.query.url){const o=await fetch(l.query.url),a=(t=o==null?void 0:o.body)==null?void 0:t.getReader();if(a){const r=[];for(;;){const{done:n,value:p}=await a.read();if(n)break;r.push(...p)}const u=new Uint8Array(r);e.binaryFile=u,e.binaryName=l.query.url.substring(l.query.url.lastIndexOf("/")+1).split("?")[0]+" "}}});const h=()=>{const t=document.createElement("input");t.type="file",t.onchange=async()=>{const o=new Blob([t.files[0]],{type:"application/octet-stream"}),a=new Uint8Array(await o.arrayBuffer());e.binaryFile=a,e.binaryName=t.files[0].name},t.click()},g=async()=>{if(!e.binaryFile){alert("\u8BF7\u9009\u62E9\u6587\u4EF6");return}d.connectPort&&await y(d.connectPort);let t=await L();e.protocol=="Official"&&await _(t,24,1e3),e.protocol=="Official"&&(await F(t,[48,5,16,0,42,79,69,70,87,45,76,79,83,69,72,85,0,0,0,0]),await _(t,24));const o=U(e.binaryFile);if(o.length>61440)throw alert("\u6700\u540E\u7684\u8FB9\u754C\u68C0\u67E5\u5931\u8D25\u3002\u4E0D\u7BA1\u662F\u8C01\u4FEE\u6539\u4E86\u4EE3\u7801\uFF0C\u4ED6\u90FD\u662F\u4E2A\u767D\u75F4\u3002"),new Error("Last resort boundary check failed. Whoever touched the code is an idiot.");for(let a=0;a<o.length;a+=256){const r=o.slice(a,a+256),u=z(r,a,o.length);try{await F(t,u),e.protocol=="Official"?await _(t,26):await G(t)}catch(n){return console.log("Flash command rejected. Aborting."),Promise.reject(n)}e.status=e.status+`\u66F4\u65B0\u8FDB\u5EA6 ${(a/o.length*100).toFixed(1)}%<br/>`,b(()=>{const n=document==null?void 0:document.getElementById("statusArea");n&&(n.scrollTop=n==null?void 0:n.scrollHeight)})}e.status=e.status+"\u66F4\u65B0\u8FDB\u5EA6 100.0%<br/>",e.status=e.status+"\u56FA\u4EF6\u66F4\u65B0\u6210\u529F",b(()=>{const a=document==null?void 0:document.getElementById("statusArea");a&&(a.scrollTop=a==null?void 0:a.scrollHeight)}),y(t),d.updateSettings({connectState:!1})};return(t,o)=>{const a=C,r=I,u=S,n=P,p=T,w=H,B=R,E=M,v=j;return V(),$("div",Q,[s(a,{items:[t.$t("menu.list"),t.$t("menu.flash")]},null,8,["items"]),s(v,{gutter:20,align:"stretch"},{default:i(()=>[s(E,{span:24},{default:i(()=>[s(B,{class:"general-card",title:t.$t("menu.flash")+t.$t("global.onBoot")},{default:i(()=>[c("div",W,[c("div",null,[s(u,null,{default:i(()=>[s(r,{onClick:h},{default:i(()=>[f(m(e.binaryFile?e.binaryName:t.$t("tool.selectFirmware")),1)]),_:1}),s(r,{type:"primary",disabled:!e.binaryFile,onClick:g},{default:i(()=>[f(m(t.$t("tool.flash")),1)]),_:1},8,["disabled"])]),_:1})]),c("div",null,[s(p,{type:"button",size:"mini",modelValue:e.protocol,"onUpdate:modelValue":o[0]||(o[0]=k=>e.protocol=k)},{default:i(()=>[s(n,{value:"Official"},{default:i(()=>[f("Official")]),_:1})]),_:1},8,["modelValue"])])]),s(w),c("div",{id:"statusArea",style:{height:"20em","background-color":"var(--color-bg-3)",color:"var(--color-text-3)",overflow:"auto",padding:"20px"},innerHTML:e.status},null,8,J)]),_:1},8,["title"])]),_:1})]),_:1})])}}});const ut=D(X,[["__scopeId","data-v-f272bde7"]]);export{ut as default};
