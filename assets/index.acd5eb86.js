import{d as nt,g as ut,_ as rt}from"./index.a4e793ee.js";import{ad as lt,ae as it,a8 as ct,a2 as dt,a0 as pt,P as mt,M as D,f as ft,a1 as gt,ab as Ft,d as _t,O as Et,U as ht,_ as St}from"./@arco-design.2114ce1c.js";import"./vue.ffb667bf.js";import{e as S,i as k,h as d,g as I,s as y,j as bt,k as At}from"./serial.c484fd9f.js";import{u as wt}from"./loading.566f8821.js";import{I as U,c as R,B as Bt,T as Dt}from"./tdesign-vue-next.ed813ef2.js";import{d as yt,r as b,h as Ct,c as $,l as Tt,m as xt,o as C,a as q,x as r,u as l,z as m,A as F,b as _,_ as vt,N as kt,O as It,F as Ut,Q as Rt,s as $t,D as T}from"./@vue.6ceb3fa6.js";import"./vue-router.a9f5d186.js";import"./nprogress.6328d444.js";import"./@intlify.02b6985d.js";import"./mitt.550594b0.js";import"./pinia.fa8b6be2.js";import"./vue-demi.0e7683c7.js";import"./axios.06033baf.js";import"./vue-i18n.5fb6db72.js";import"./@vueuse.a7db99fe.js";import"./@zxing.8654f0db.js";import"./@microsoft.d2aaf3b7.js";import"./vue-matomo.5bdfe9a5.js";import"./b-tween.8dd4e2fe.js";import"./dayjs.35d19ede.js";import"./b-validate.1fdaeb97.js";import"./number-precision.5cddbed2.js";import"./resize-observer-polyfill.2b976e6e.js";import"./scroll-into-view-if-needed.0a5da943.js";import"./compute-scroll-into-view.17358474.js";import"./lodash-es.18922ecc.js";import"./sortablejs.77296005.js";import"./@popperjs.f3f73334.js";import"./@babel.9b6013fe.js";const qt={class:"container"},Ot={style:{"text-align":"center"}},Nt=["src"],Vt={style:{width:"100%"}},Lt=["innerHTML"],Mt={name:"Sat"},Ht=yt({...Mt,setup(Pt){const{loading:O,setLoading:p}=wt(!0),i=nt();b(null),b(null),b(null);const a=Ct({uuid:"",qrcode:"",visible:!1,showHide:0,status:"\u70B9\u51FB\u5199\u5165\u6309\u94AE\u5199\u5165\u536B\u661F\u6570\u636E\u5230\u8BBE\u5907<br/><br/>",sat:"",satData:[],lng:0,lat:0,alt:0,tx:0,rx:0,txTone:0,rxTone:0,CTCSSOption:[0,67,69.3,71.9,74.4,77,79.7,82.5,85.4,88.5,91.5,94.8,97.4,100,103.5,107.2,110.9,114.8,118.8,123,127.3,131.8,136.5,141.3,146.2,151.4,156.7,159.8,162.2,165.5,167.9,171.3,173.8,177.3,179.9,183.5,186.2,189.9,192.8,196.6,199.5,203.5,206.5,210.7,218.1,225.7,229.1,233.6,241.8,250.3,254.1],pass:void 0,passOption:[],dt:"",timer:void 0,passCustom:void 0,dtCustom:void 0,freqDb:[],selfSatModal:!1,selfSatInfo:"",satsData:[]}),x=$(()=>i.isUve5),A=t=>new TextDecoder("utf-8",{fatal:!1}).decode(t).replace(/\u0000/g," "),N=async(t,e)=>{const o=new Uint8Array(e);for(let s=0;s<e;s+=128){const n=Math.min(128,e-s),u=await bt(i.connectPort,t+s,n);o.set(u.subarray(0,n),s)}return o},V=t=>{if(!t||t.length<160)return{ok:!1,reason:"readback too short"};const e=t.subarray(0,9),o=t.subarray(9,9+69),s=t.subarray(9+69,9+69+69),n=(E,w)=>E.every(B=>B===w);if(n(t,0)||n(t,255))return{ok:!1,reason:"all 0x00/0xFF"};const u=A(e).trim(),f=A(o),g=A(s);return f.startsWith("1 ")&&g.startsWith("2 ")?{ok:!0,reason:"",name:u,line1:f,line2:g}:{ok:!1,reason:`unexpected TLE header (name='${u}')`}},L=t=>{const{row:e}=t;return e.status!==2},M=b(),H=$(()=>[{title:"\u536B\u661F\u540D\u79F0",colKey:"satName"},{title:"\u4E0A\u884C\u9891\u7387",colKey:"txFreq",align:"left",edit:{component:U,props:{clearable:!0,autofocus:!0},validateTrigger:"change",on:t=>({onBlur:()=>{console.log("\u5931\u53BB\u7126\u70B9",t)},onEnter:e=>{var o;(o=e==null?void 0:e.e)==null||o.preventDefault(),console.log("onEnter",e)}}),abortEditOnEvent:["onEnter"],onEdited:t=>{console.log(t);const e=[...a.satsData];e.splice(t.rowIndex,1,t.newRowData),a.satsData=e,console.log("Edit firstName:",t)},rules:[{required:!0,message:"\u4E0D\u80FD\u4E3A\u7A7A"}],defaultEditable:!0}},{title:"\u4E0A\u884C\u4E9A\u97F3",colKey:"txTone",edit:{component:R,props:{clearable:!0,options:a.CTCSSOption.map(t=>({label:t,value:t}))},on:t=>({onChange:e=>{console.log("status changed",t,e)}}),onEdited:t=>{a.satsData.splice(t.rowIndex,1,t.newRowData),console.log("Edit Framework:",t)}}},{title:"\u4E0B\u884C\u9891\u7387",colKey:"rxFreq",align:"left",edit:{component:U,props:{clearable:!0,autofocus:!0},validateTrigger:"change",on:t=>({onBlur:()=>{console.log("\u5931\u53BB\u7126\u70B9",t)},onEnter:e=>{var o;(o=e==null?void 0:e.e)==null||o.preventDefault(),console.log("onEnter",e)}}),abortEditOnEvent:["onEnter"],onEdited:t=>{console.log(t);const e=[...a.satsData];e.splice(t.rowIndex,1,t.newRowData),a.satsData=e,console.log("Edit firstName:",t)},rules:[{required:!0,message:"\u4E0D\u80FD\u4E3A\u7A7A"}],defaultEditable:!0}},{title:"\u4E0B\u884C\u4E9A\u97F3",colKey:"rxTone",edit:{component:R,props:{clearable:!0,options:a.CTCSSOption.map(t=>({label:t,value:t}))},on:t=>({onChange:e=>{console.log("status changed",t,e)}}),onEdited:t=>{a.satsData.splice(t.rowIndex,1,t.newRowData),console.log("Edit Framework:",t)}}}]);Tt(async()=>{try{if(sessionStorage.getItem("satFrequenciesRst"))a.freqDb=JSON.parse(sessionStorage.getItem("satFrequenciesRst")||"[]");else{const t=await(await fetch("https://github.jobcher.com/gh/https://raw.githubusercontent.com/palewire/ham-satellite-database/main/data/amsat-active-frequencies.json")).text();a.freqDb=JSON.parse(t),sessionStorage.setItem("satFrequenciesRst",t)}}catch{}a.timer=setInterval(()=>{a.dt=new Date().toLocaleString(),localStorage.setItem("myLng",a.lng.toString()),localStorage.setItem("myLat",a.lat.toString()),localStorage.setItem("myAlt",a.alt.toString())},1e3)}),xt(()=>{try{clearInterval(a.timer)}catch{}});const P=async()=>{if(i.connectState!=!0){alert(sessionStorage.getItem("noticeConnectK5"));return}p(!0),await S(i.connectPort),await z(),await k(i.connectPort),p(!1)},z=async()=>{var o;const t=a.dtCustom?new Date(a.dtCustom):new Date,e=[...d(parseInt(t.getUTCFullYear().toString().substring(2,4)).toString(16)),...d((t.getUTCMonth()+1).toString(16)),...d(t.getUTCDate().toString(16)),...d(t.getUTCHours().toString(16)),...d(t.getUTCMinutes().toString(16)),...d(t.getUTCSeconds().toString(16))];await I(i.connectPort,11168,new Uint8Array(e),6,(o=i.configuration)==null?void 0:o.uart)},Z=async t=>{const e=a.satData.find(o=>o.name==t);if(e&&e.path){a.status+="<br/>\u536B\u661F\u53C2\u6570\uFF1A<br/>",e.path.map(s=>{a.status+=s+"<br/>"});let o=!1;a.freqDb.map(s=>{e.path[1].split(" ")[1]==s.norad_id&&s.mode.indexOf("FM")!=-1&&(console.log(s),o=!0,a.tx=s.uplink?parseFloat(s.uplink.split("/")[0]):0,a.rx=s.downlink?parseFloat(s.downlink.split("/")[0]):0,a.txTone=parseFloat(a.CTCSSOption.reduce((n,u)=>s.mode.indexOf(u)!=-1?u:n)))}),o||(a.tx=0,a.rx=0,a.txTone=0,a.rxTone=0),a.satsData.push({satName:t,line:e.path,txFreq:a.tx,txTone:a.txTone,rxFreq:a.rx,rxTone:a.rxTone}),console.log(a.satsData)}T(()=>{const o=document==null?void 0:document.getElementById("statusArea");o&&(o.scrollTop=o==null?void 0:o.scrollHeight)})};(async()=>{p(!0);let t="";sessionStorage.getItem("satRst")?t=sessionStorage.getItem("satRst")||"":(t=await(await fetch("https://celestrak.org/NORAD/elements/amateur.txt")).text(),sessionStorage.setItem("satRst",t));const e=t.split(/\r?\n/),o=[];let s={};for(let n=0;n<e.length;n++)Number.isNaN(parseInt(e[n].substring(0,1)))?(s.name&&s.name!=""&&(o.push(s),s={}),s.name=e[n]):(s.path||(s.path=[]),s.path.push(e[n]));a.satData=o,p(!1)})();const K=async()=>{const t=await(await fetch("https://k5.vicicode.cn/api/lol",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({func:1,uuid:a.uuid})})).json(),e=JSON.parse(t.cache);e.length>=3&&(a.lng=e[0],a.lat=e[1],a.alt=e[2])},j=async(t=0,e)=>{var o;await S(i.connectPort);for(let s=t;s<e.length+t;s+=64)await I(i.connectPort,s,e.slice(s-t,s-t+64),64,(o=i.configuration)==null?void 0:o.uart),a.status=a.status+"\u5199\u5165\u8FDB\u5EA6\uFF1A"+((s-t)/e.length*100).toFixed(1)+"%<br/>",T(()=>{const n=document==null?void 0:document.getElementById("statusArea");n&&(n.scrollTop=n==null?void 0:n.scrollHeight)});a.status=a.status+"\u5199\u5165\u8FDB\u5EA6\uFF1A100.0%<br/>"},Y=async(t,e)=>{await S(i.connectPort);for(let o=0;o<e.length;o+=64){const s=e.slice(o,o+64);await At(i.connectPort,t+o,s,s.length),a.status=a.status+"\u5199\u5165\u8FDB\u5EA6\uFF1A"+(o/e.length*100).toFixed(1)+"%<br/>",T(()=>{const n=document==null?void 0:document.getElementById("statusArea");n&&(n.scrollTop=n==null?void 0:n.scrollHeight)})}a.status=a.status+"\u5199\u5165\u8FDB\u5EA6\uFF1A100.0%<br/>"},J=t=>{const e=t.replace(/\d$/,"");let o=0;for(const s of e)s==="-"?o+=1:o+=parseInt(s,10)||0;return o%10},v=t=>{const e=parseInt(t[68],10),o=J(t);return e===o},W=async()=>{var o,s;if(i.connectState!=!0){alert(sessionStorage.getItem("noticeConnectK5"));return}if(!x.value&&((o=i.configuration)==null?void 0:o.sat2)!=!0){alert(sessionStorage.getItem("noticeVersionNoSupport"));return}p(!0),await S(i.connectPort);let t=new Uint8Array(160*45),e="";for(let n=0;n<a.satsData.length;n++){const u=a.satsData[n];t.set(y(u.satName).subarray(0,9),n*160),t.set(y(u.line[0]).subarray(0,69),n*160+9),v(u.line[0])||(e+=`\u7B2C ${n+1} \u884C\u536B\u661F\u661F\u5386\u7B2C\u4E00\u884C\u6570\u636E\u9519\u8BEF\uFF1B`),t.set(y(u.line[1]).subarray(0,69),n*160+9+69),v(u.line[1])||(e+=`\u7B2C ${n+1} \u884C\u536B\u661F\u661F\u5386\u7B2C\u4E8C\u884C\u6570\u636E\u9519\u8BEF\uFF1B`);const f=new Uint8Array(2);u.txTone&&u.txTone>0&&f.set(d(parseInt((u.txTone*10).toFixed(0)).toString(16)).subarray(0,2)),t.set(f,n*160+9+69+69);const g=new Uint8Array(2);u.rxTone&&u.rxTone>0&&g.set(d(parseInt((u.rxTone*10).toFixed(0)).toString(16)).subarray(0,2)),t.set(g,n*160+9+69+69+2);const h=new Uint8Array(4);h.set(d(parseInt((u.txFreq*1e6/10).toFixed(0)).toString(16))),t.set(h,n*160+9+69+69+2+2),parseInt((u.txFreq*1e6/10).toFixed(0))==0&&(e+=`\u7B2C ${n+1} \u884C\u536B\u661F\u7F3A\u5C11\u4E0A\u884C\u9891\u7387\uFF1B`);const E=new Uint8Array(4);E.set(d(parseInt((u.rxFreq*1e6/10).toFixed(0)).toString(16))),t.set(E,n*160+9+69+69+2+2+4),parseInt((u.rxFreq*1e6/10).toFixed(0))==0&&(e+=`\u7B2C ${n+1} \u884C\u536B\u661F\u7F3A\u5C11\u4E0B\u884C\u9891\u7387\uFF1B`)}if(e!="")return p(!1),D.error({content:e,duration:10*1e3});if(x.value){a.status+=`\u68C0\u6D4B\u5230 UVE \u8BBE\u5907\uFF1A\u5C06\u5199\u5165 shared@0x${65536 .toString(16)}<br/>`,await Y(65536,t);try{const n=await N(65536,160),u=V(n);if(!u.ok)return p(!1),D.error({content:`\u5199\u5165\u5B8C\u6210\u4F46\u8BFB\u56DE\u6821\u9A8C\u5931\u8D25\uFF1A${u.reason}\u3002\u8FD9\u901A\u5E38\u8868\u793A shared \u5206\u533A\u4E0D\u53EF\u7528\uFF08\u5206\u533A\u8868\u6CA1\u5237/label \u4E0D\u5339\u914D\uFF09\u6216\u56FA\u4EF6\u672A\u652F\u6301 shared \u8BFB\u5199\u547D\u4EE4\u3002

\u5982\u679C\u4F60\u662F\u7528 app0_main \u7684\u5FEB\u901F\u4E0A\u4F20\u5237\u673A\uFF1A\u8BF7\u786E\u4FDD partitions.bin \u4E5F\u88AB\u5199\u5165\uFF08\u672C\u4ED3\u5E93 scripts/upload_app0.py \u5DF2\u6539\u4E3A\u540C\u65F6\u5237 partitions.bin@0x8000\uFF09\u3002\u6216\u8005\u5B8C\u6574\u5237\u4E00\u6B21 factory/\u5206\u533A\u8868\u540E\u518D\u91CD\u8BD5\u3002`,duration:12*1e3});a.status+=`\u8BFB\u56DE\u6821\u9A8C\u901A\u8FC7\uFF1A${u.name}<br/>`}catch(n){return p(!1),D.error({content:`\u5199\u5165\u5B8C\u6210\u4F46\u8BFB\u56DE\u6821\u9A8C\u5F02\u5E38\uFF1A${(s=n==null?void 0:n.message)!=null?s:n}\u3002\u53EF\u80FD\u56FA\u4EF6\u4E0D\u652F\u6301 shared_read/shared_write\u3002`,duration:12*1e3})}}else a.status+="\u975E UVE \u8BBE\u5907\uFF1A\u5C06\u5199\u5165 EEPROM@0x1E200<br/>",await j(123392,t);await k(i.connectPort),p(!1)},Q=t=>!!new RegExp("^(https?:\\/\\/)?((([a-zA-Z\\d]([a-zA-Z\\d-]*[a-zA-Z\\d])*)\\.)+[a-zA-Z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-zA-Z\\d%_.~+]*)*(\\?[;&a-zA-Z\\d%_.~+=-]*)?(\\#[-a-zA-Z\\d_]*)?$","i").test(t),G=async()=>{Q(a.selfSatInfo)&&(a.selfSatInfo=await(await fetch(a.selfSatInfo)).text());const t=(a.selfSatInfo+`
`).split(/\r?\n/),e=[];let o={};for(let s=0;s<t.length;s++)Number.isNaN(parseInt(t[s].substring(0,1)))?(o.name&&o.name!=""&&(e.push(o),o={}),o.name=t[s]):(o.path||(o.path=[]),o.path.push(t[s]));a.satData=e.concat(a.satData),a.selfSatInfo=""};return(t,e)=>{const o=lt,s=ft,n=ut,u=gt,f=it,g=Bt,h=Ft,E=ct,w=dt,B=Dt,X=_t,tt=Et,et=pt,at=mt,ot=ht,st=St;return C(),q("div",qt,[r(s,{width:"650px",visible:a.selfSatModal,"onUpdate:visible":e[1]||(e[1]=c=>a.selfSatModal=c),onOk:G},{title:l(()=>[m(F(t.$t("sat.selfSatInfo")),1)]),default:l(()=>[_("div",null,[r(o,{modelValue:a.selfSatInfo,"onUpdate:modelValue":e[0]||(e[0]=c=>a.selfSatInfo=c),style:{height:"120px"},placeholder:`ISS (ZARYA)             \r
  1 25544U 98067A   24320.36274227  .00015569  00000+0  28188-3 0  9999\r
  2 25544  51.6413 286.4173 0007936 217.3657 298.3197 15.49809951481990`},null,8,["modelValue"])])]),_:1},8,["visible"]),r(s,{visible:a.visible,"onUpdate:visible":e[2]||(e[2]=c=>a.visible=c),onOk:K,"ok-text":t.$t("tool.scaned")},{title:l(()=>[m(F(t.$t("tool.scanqr")),1)]),default:l(()=>[_("div",Ot,[_("img",{src:a.qrcode},null,8,Nt),e[7]||(e[7]=_("br",null,null,-1)),m(" "+F(t.$t("tool.scannotice")),1)])]),_:1},8,["visible","ok-text"]),r(n,{items:[t.$t("menu.list"),t.$t("menu.satellite2")]},null,8,["items"]),r(st,{gutter:20,align:"stretch"},{default:l(()=>[r(ot,{span:24},{default:l(()=>[r(at,{class:"general-card",title:t.$t("menu.satellite2")+t.$t("global.onStart")},{default:l(()=>[r(et,{loading:vt(O),style:{width:"100%"},tip:"\u6B63\u5728\u5904\u7406 ..."},{default:l(()=>[r(u,{"label-col-style":{width:"25%"},field:"dt",label:t.$t("tool.brtime"),onClick:e[3]||(e[3]=()=>{a.showHide+=1})},{default:l(()=>[m(F(a.dt),1)]),_:1},8,["label"]),kt(r(u,{"label-col-style":{width:"25%"},field:"dtCustom",label:"\u81EA\u5B9A\u4E49\u65F6\u95F4"},{default:l(()=>[_("div",null,[r(f,{style:{width:"220px",margin:"0 24px 24px 0"},"show-time":"","time-picker-props":{defaultValue:"00:00:00"},format:"YYYY-MM-DD HH:mm:ss",modelValue:a.dtCustom,"onUpdate:modelValue":e[4]||(e[4]=c=>a.dtCustom=c)},null,8,["modelValue"]),e[9]||(e[9]=m(" \xA0\xA0",-1)),r(g,{size:"small",theme:"success",onClick:P},{default:l(()=>[...e[8]||(e[8]=[m("\u5199\u5165\u65F6\u95F4\u5230\u53F0\u7AD9",-1)])]),_:1})])]),_:1},512),[[It,a.showHide>=5]]),r(u,{"label-col-style":{width:"25%"},field:"sat",label:t.$t("tool.selectSatellite")},{default:l(()=>[_("div",Vt,[r(E,{modelValue:a.sat,"onUpdate:modelValue":e[5]||(e[5]=c=>a.sat=c),onChange:Z,placeholder:t.$t("tool.selectSatellite")+"...","allow-search":"","allow-clear":""},{default:l(()=>[(C(!0),q(Ut,null,Rt(a.satData,c=>(C(),$t(h,{key:c.name,value:c.name},{default:l(()=>[m(F(c.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue","placeholder"]),r(w,{onClick:e[6]||(e[6]=()=>{a.selfSatModal=!0}),style:{"margin-top":"10px"}},{default:l(()=>[m(F(t.$t("sat.addSelfSat")),1)]),_:1})])]),_:1},8,["label"]),r(u,{"label-col-style":{width:"25%"},field:"sat",label:""},{default:l(()=>[r(B,{ref_key:"tableRef",ref:M,"row-key":"key",columns:H.value,data:a.satsData,"editable-cell-state":L,bordered:"","lazy-load":""},null,8,["columns","data"])]),_:1}),r(u,{"label-col-style":{width:"25%"},label:""},{default:l(()=>[r(X,{type:"primary",onClick:W},{default:l(()=>[m(F(t.$t("tool.writeData")),1)]),_:1})]),_:1}),r(tt),_("div",{id:"statusArea",style:{height:"20em","background-color":"var(--color-bg-3)",color:"var(--color-text-3)",overflow:"auto",padding:"20px"},innerHTML:a.status},null,8,Lt)]),_:1},8,["loading"])]),_:1},8,["title"])]),_:1})]),_:1})])}}});const Ae=rt(Ht,[["__scopeId","data-v-91eee51d"]]);export{Ae as default};
