import{d as k,g as D,_ as O}from"./index.8783e479.js";import{a6 as K,P as N,d as P,k as V,a7 as x,O as $,U as R,_ as S}from"./@arco-design.10d71e42.js";import"./vue.ffb667bf.js";import{u as T}from"./vue-router.a9f5d186.js";import{d as E,c as I,r as _,j as F,k as U,l as y,m as j,n as q,o as H}from"./serial.b0855796.js";import{D as M}from"./tdesign-vue-next.ed813ef2.js";import{d as L,h as z,l as G,o as W,a as J,x as i,u as s,b as m,z as p,A as g,D as b}from"./@vue.6ceb3fa6.js";import"./nprogress.6328d444.js";import"./@intlify.02b6985d.js";import"./mitt.550594b0.js";import"./pinia.fa8b6be2.js";import"./vue-demi.0e7683c7.js";import"./axios.06033baf.js";import"./vue-i18n.5fb6db72.js";import"./@vueuse.a7db99fe.js";import"./@zxing.8654f0db.js";import"./@microsoft.d2aaf3b7.js";import"./vue-matomo.5bdfe9a5.js";import"./b-tween.8dd4e2fe.js";import"./dayjs.35d19ede.js";import"./b-validate.1fdaeb97.js";import"./number-precision.5cddbed2.js";import"./resize-observer-polyfill.2b976e6e.js";import"./scroll-into-view-if-needed.0a5da943.js";import"./compute-scroll-into-view.17358474.js";import"./lodash-es.18922ecc.js";import"./sortablejs.77296005.js";import"./@popperjs.f3f73334.js";import"./@babel.9b6013fe.js";const Q={class:"container"},X={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Y=["innerHTML"],Z={name:"Flash"},tt=L({...Z,setup(et){const f=k(),t=z({status:"\u70B9\u51FB\u66F4\u65B0\u6309\u94AE\u66F4\u65B0\u56FA\u4EF6\u5230\u8BBE\u5907<br/><br/>",binaryFile:void 0,binaryName:"",protocol:"Official"}),d=T();G(async()=>{var a;if(d.query.url){const r=await fetch(d.query.url),n=(a=r==null?void 0:r.body)==null?void 0:a.getReader();if(n){const o=[];for(;;){const{done:c,value:u}=await n.read();if(c)break;o.push(...u)}const l=new Uint8Array(o);t.binaryFile=l,t.binaryName=d.query.url.substring(d.query.url.lastIndexOf("/")+1).split("?")[0]+" "}}const e=M.confirm({theme:"danger",header:"\u63D0\u793A",body:"\u6CC9\u76DB K5/K6 \u5F53\u524D\u5728\u552E\u4E24\u4E2A\u786C\u4EF6\u7248\u672C\uFF0C\u5982\u4F7F\u7528\u7B2C\u4E09\u65B9\u56FA\u4EF6\u8BF7\u5148\u4E0E\u5546\u5BB6\u786E\u8BA4\u53EF\u4EE5\u5347\u7EA7\u5230\u7B2C\u4E09\u65B9\u56FA\u4EF6\u3002",className:"t-dialog-new-class1 t-dialog-new-class2",style:"color: rgba(0, 0, 0, 0.6)",confirmBtn:"\u6211\u77E5\u9053\u4E86",cancelBtn:null,closeBtn:!1,onConfirm:()=>{e.destroy()},closeOnEscKeydown:!1,closeOnOverlayClick:!1})});const B=()=>{const e=document.createElement("input");e.type="file",e.onchange=async()=>{const a=new Blob([e.files[0]],{type:"application/octet-stream"}),r=new Uint8Array(await a.arrayBuffer());t.binaryFile=r,t.binaryName=e.files[0].name},e.click()},w=async()=>{if(!t.binaryFile){alert("\u8BF7\u9009\u62E9\u6587\u4EF6");return}f.connectPort&&await E(f.connectPort);let e=await I();t.protocol=="Official"&&await _(e,24,1e3),t.protocol=="K1"&&await F(e);const a=U(t.binaryFile),r=new Uint8Array([48,5,a.length,0,...a]);(t.protocol=="Official"||t.protocol=="K1")&&(t.protocol=="K1"?(await y(e,r),await F(e)):(await y(e,[48,5,16,0,42,79,69,70,87,45,76,79,83,69,72,85,0,0,0,0]),await _(e,24)));const n=j(t.binaryFile);if(n.length>61440&&t.protocol=="Official")throw alert("\u6700\u540E\u7684\u8FB9\u754C\u68C0\u67E5\u5931\u8D25\u3002\u4E0D\u7BA1\u662F\u8C01\u4FEE\u6539\u4E86\u4EE3\u7801\uFF0C\u4ED6\u90FD\u662F\u4E2A\u767D\u75F4\u3002"),new Error("Last resort boundary check failed. Whoever touched the code is an idiot.");for(let o=0;o<n.length;o+=256){const l=n.slice(o,o+256);let c;t.protocol=="K1"?c=q(l,o,n.length):c=H(l,o,n.length);try{await y(e,c),t.protocol=="Official"?await _(e,26):await F(e)}catch(u){return console.log("Flash command rejected. Aborting."),Promise.reject(u)}t.status=t.status+`\u66F4\u65B0\u8FDB\u5EA6 ${(o/n.length*100).toFixed(1)}%<br/>`,b(()=>{const u=document==null?void 0:document.getElementById("statusArea");u&&(u.scrollTop=u==null?void 0:u.scrollHeight)})}t.status=t.status+"\u66F4\u65B0\u8FDB\u5EA6 100.0%<br/>",t.status=t.status+"\u56FA\u4EF6\u66F4\u65B0\u6210\u529F",b(()=>{const o=document==null?void 0:document.getElementById("statusArea");o&&(o.scrollTop=o==null?void 0:o.scrollHeight)}),E(e),f.updateSettings({connectState:!1})};return(e,a)=>{const r=D,n=P,o=V,l=K,c=x,u=$,h=N,A=R,v=S;return W(),J("div",Q,[i(r,{items:[e.$t("menu.list"),e.$t("menu.flash")]},null,8,["items"]),i(v,{gutter:20,align:"stretch"},{default:s(()=>[i(A,{span:24},{default:s(()=>[i(h,{class:"general-card",title:e.$t("menu.flash")+e.$t("global.onBoot")},{default:s(()=>[m("div",X,[m("div",null,[i(o,null,{default:s(()=>[i(n,{onClick:B},{default:s(()=>[p(g(t.binaryFile?t.binaryName:e.$t("tool.selectFirmware")),1)]),_:1}),i(n,{type:"primary",disabled:!t.binaryFile,onClick:w},{default:s(()=>[p(g(e.$t("tool.flash")),1)]),_:1},8,["disabled"])]),_:1})]),m("div",null,[i(c,{type:"button",size:"mini",modelValue:t.protocol,"onUpdate:modelValue":a[0]||(a[0]=C=>t.protocol=C)},{default:s(()=>[i(l,{value:"Official"},{default:s(()=>[...a[1]||(a[1]=[p("Official",-1)])]),_:1}),i(l,{value:"K1"},{default:s(()=>[...a[2]||(a[2]=[p("K1",-1)])]),_:1})]),_:1},8,["modelValue"])])]),i(u),m("div",{id:"statusArea",style:{height:"20em","background-color":"var(--color-bg-3)",color:"var(--color-text-3)",overflow:"auto",padding:"20px"},innerHTML:t.status},null,8,Y)]),_:1},8,["title"])]),_:1})]),_:1})])}}});const Nt=O(tt,[["__scopeId","data-v-5f59f32e"]]);export{Nt as default};
