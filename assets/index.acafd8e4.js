import{d as O,g as P,_ as M}from"./index.a4e793ee.js";import{a6 as N,ac as U,P as $,d as K,k as S,a7 as R,O as T,U as I,_ as j}from"./@arco-design.2114ce1c.js";import"./vue.ffb667bf.js";import{u as q}from"./vue-router.a9f5d186.js";import{d as D,c as L,l as H,m as A,n as x,o as z,p as C,q as G,t as W,v as J}from"./serial.c484fd9f.js";import{D as Q}from"./tdesign-vue-next.ed813ef2.js";import{d as X,h as Y,l as Z,o as tt,a as et,x as i,u as l,b as d,z as g,A as b,D as ot}from"./@vue.6ceb3fa6.js";import"./nprogress.6328d444.js";import"./@intlify.02b6985d.js";import"./mitt.550594b0.js";import"./pinia.fa8b6be2.js";import"./vue-demi.0e7683c7.js";import"./axios.06033baf.js";import"./vue-i18n.5fb6db72.js";import"./@vueuse.a7db99fe.js";import"./@zxing.8654f0db.js";import"./@microsoft.d2aaf3b7.js";import"./vue-matomo.5bdfe9a5.js";import"./b-tween.8dd4e2fe.js";import"./dayjs.35d19ede.js";import"./b-validate.1fdaeb97.js";import"./number-precision.5cddbed2.js";import"./resize-observer-polyfill.2b976e6e.js";import"./scroll-into-view-if-needed.0a5da943.js";import"./compute-scroll-into-view.17358474.js";import"./lodash-es.18922ecc.js";import"./sortablejs.77296005.js";import"./@popperjs.f3f73334.js";import"./@babel.9b6013fe.js";const at={class:"container"},st={style:{display:"flex","justify-content":"space-between","align-items":"center"}},ut={style:{"margin-bottom":"12px"}},nt={style:{display:"flex","justify-content":"space-between","margin-bottom":"4px"}},it={style:{color:"var(--color-text-1)","font-weight":"bold"}},rt={style:{"margin-top":"6px",color:"var(--color-text-3)"}},lt=["innerHTML"],ct={name:"Flash"},pt=X({...ct,setup(dt){const w=O(),t=Y({status:"\u70B9\u51FB\u66F4\u65B0\u6309\u94AE\u66F4\u65B0\u56FA\u4EF6\u5230\u8BBE\u5907<br/><br/>",binaryFile:void 0,binaryName:"",protocol:"Official",progress:0,phase:"",isFlashing:!1}),h=q();Z(async()=>{var e;if(h.query.url){const r=await fetch(h.query.url),c=(e=r==null?void 0:r.body)==null?void 0:e.getReader();if(c){const u=[];for(;;){const{done:o,value:F}=await c.read();if(o)break;u.push(...F)}const f=new Uint8Array(u);t.binaryFile=f,t.binaryName=h.query.url.substring(h.query.url.lastIndexOf("/")+1).split("?")[0]+" "}}const a=Q.confirm({theme:"danger",header:"\u63D0\u793A",body:"\u6CC9\u76DB K5/K6 \u5F53\u524D\u5728\u552E\u4E24\u4E2A\u786C\u4EF6\u7248\u672C\uFF0C\u5982\u4F7F\u7528\u7B2C\u4E09\u65B9\u56FA\u4EF6\u8BF7\u5148\u4E0E\u5546\u5BB6\u786E\u8BA4\u53EF\u4EE5\u5347\u7EA7\u5230\u7B2C\u4E09\u65B9\u56FA\u4EF6\u3002",className:"t-dialog-new-class1 t-dialog-new-class2",style:"color: rgba(0, 0, 0, 0.6)",confirmBtn:"\u6211\u77E5\u9053\u4E86",cancelBtn:null,closeBtn:!1,onConfirm:()=>{a.destroy()},closeOnEscKeydown:!1,closeOnOverlayClick:!1})});const k=()=>{const a=document.createElement("input");a.type="file",a.onchange=async()=>{const e=new Blob([a.files[0]],{type:"application/octet-stream"}),r=new Uint8Array(await e.arrayBuffer());t.binaryFile=r,t.binaryName=a.files[0].name},a.click()},V=async()=>{var F;if(!t.binaryFile){alert("\u8BF7\u9009\u62E9\u6587\u4EF6");return}const a=2e5;let e=[],r=null;const c=()=>{r=null,e.length&&(t.status=t.status+e.join("<br/>")+"<br/>",e=[],typeof t.status=="string"&&t.status.length>a&&(t.status=t.status.slice(-Math.floor(a*.75))),ot(()=>{const s=document==null?void 0:document.getElementById("statusArea");s&&(s.scrollTop=s==null?void 0:s.scrollHeight)}))},u=s=>{e.push(s),r===null&&(r=window.setTimeout(c,50))};if(t.isFlashing)return;t.isFlashing=!0,t.progress=0,t.phase="",w.connectPort&&await D(w.connectPort);const f=t.protocol==="UVE5"?115200:38400;let o=null;try{if(o=await L(f),!o){u("\u4E32\u53E3\u8FDE\u63A5\u5931\u8D25");return}if(t.protocol==="UVE5"){t.phase="\u5237\u5199\u4E2D...",u("UVE5\uFF1A\u5F00\u59CB\u5237\u5199\uFF08115200bps\uFF09");let n=-1;await H(o,t.binaryFile,{onLog:m=>{u(m)},onProgress:(m,_)=>{const v=_>0?m/_*100:0,y=Math.min(100,Math.max(0,Number(v.toFixed(1))));t.progress=y,t.phase=`\u5237\u5199\u4E2D... ${y.toFixed(1)}%`;const E=Math.floor(y);(E!==n||E===0||E===100)&&(n=E,u(`\u66F4\u65B0\u8FDB\u5EA6 ${y.toFixed(1)}%`))}}),t.progress=100,t.phase="\u5B8C\u6210",u("UVE5\uFF1A\u56FA\u4EF6\u5237\u5199\u5B8C\u6210");return}t.protocol=="Official"&&await A(o,24,1e3),t.protocol=="K1"&&await x(o);const s=z(t.binaryFile),B=new Uint8Array([48,5,s.length,0,...s]);(t.protocol=="Official"||t.protocol=="K1")&&(t.protocol=="K1"?(await C(o,B),await x(o)):(await C(o,[48,5,16,0,42,79,69,70,87,45,76,79,83,69,72,85,0,0,0,0]),await A(o,24)));const p=G(t.binaryFile);if(p.length>61440&&t.protocol=="Official")throw alert("\u6700\u540E\u7684\u8FB9\u754C\u68C0\u67E5\u5931\u8D25\u3002\u4E0D\u7BA1\u662F\u8C01\u4FEE\u6539\u4E86\u4EE3\u7801\uFF0C\u4ED6\u90FD\u662F\u4E2A\u767D\u75F4\u3002"),new Error("Last resort boundary check failed. Whoever touched the code is an idiot.");for(let n=0;n<p.length;n+=256){const m=p.slice(n,n+256);let _;t.protocol=="K1"?_=W(m,n,p.length):_=J(m,n,p.length);try{await C(o,_),t.protocol=="Official"?await A(o,26):await x(o,10*1e3)}catch(v){return console.log("Flash command rejected. Aborting."),Promise.reject(v)}u(`\u66F4\u65B0\u8FDB\u5EA6 ${(n/p.length*100).toFixed(1)}%`),t.progress=Math.min(100,Math.max(0,Number((n/p.length*100).toFixed(1))))}u("\u66F4\u65B0\u8FDB\u5EA6 100.0%"),t.progress=100,u("\u56FA\u4EF6\u66F4\u65B0\u6210\u529F"),c()}catch(s){t.phase="\u5931\u8D25",u(`${t.protocol}\uFF1A\u5931\u8D25 - ${(F=s==null?void 0:s.message)!=null?F:s}`),c()}finally{try{o&&await D(o)}catch{}w.updateSettings({connectState:!1}),t.isFlashing=!1}};return(a,e)=>{const r=P,c=K,u=S,f=N,o=R,F=T,s=U,B=$,p=I,n=j;return tt(),et("div",at,[i(r,{items:[a.$t("menu.list"),a.$t("menu.flash")]},null,8,["items"]),i(n,{gutter:20,align:"stretch"},{default:l(()=>[i(p,{span:24},{default:l(()=>[i(B,{class:"general-card",title:a.$t("menu.flash")+a.$t("global.onBoot")},{default:l(()=>[d("div",st,[d("div",null,[i(u,null,{default:l(()=>[i(c,{disabled:t.isFlashing,onClick:k},{default:l(()=>[g(b(t.binaryFile?t.binaryName:a.$t("tool.selectFirmware")),1)]),_:1},8,["disabled"]),i(c,{type:"primary",disabled:!t.binaryFile||t.isFlashing,onClick:V},{default:l(()=>[g(b(a.$t("tool.flash")),1)]),_:1},8,["disabled"])]),_:1})]),d("div",null,[i(o,{type:"button",size:"mini",modelValue:t.protocol,"onUpdate:modelValue":e[0]||(e[0]=m=>t.protocol=m)},{default:l(()=>[i(f,{value:"Official"},{default:l(()=>[...e[1]||(e[1]=[g("Official",-1)])]),_:1}),i(f,{value:"K1"},{default:l(()=>[...e[2]||(e[2]=[g("K1",-1)])]),_:1}),i(f,{value:"UVE5"},{default:l(()=>[...e[3]||(e[3]=[g("UVE5",-1)])]),_:1})]),_:1},8,["modelValue"])])]),i(F),d("div",ut,[d("div",nt,[e[4]||(e[4]=d("div",{style:{color:"var(--color-text-2)"}},"\u8FDB\u5EA6\u6761",-1)),d("div",it,b(t.progress.toFixed(1))+"%",1)]),i(s,{percent:t.progress/100,"show-text":!1},null,8,["percent"]),d("div",rt,b(t.phase),1)]),d("div",{id:"statusArea",style:{height:"20em","background-color":"var(--color-bg-3)",color:"var(--color-text-3)",overflow:"auto",padding:"20px"},innerHTML:t.status},null,8,lt)]),_:1},8,["title"])]),_:1})]),_:1})])}}});const jt=M(pt,[["__scopeId","data-v-0bb4bc2e"]]);export{jt as default};
