import{t as A,ad as C,_ as D}from"./index.38892ecc.js";/* empty css              *//* empty css              *//* empty css               *//* empty css                *//* empty css               */import{d as N,r as O,o as I,bW as P,bI as V,C as $,D as x,aI as s,aH as i,G as c,aM as f,aN as _,n as b,b8 as R,bi as S,bX as T,bG as H,bK as M,bO as j}from"./arco.13f9ef32.js";import{f as q}from"./vue.eb9ee7d7.js";import{d as y,c as G,r as m,j as F,k as L,l as U,m as W}from"./serial.d615852e.js";import"./chart.5acd6cf6.js";const z={class:"container"},K={style:{display:"flex","justify-content":"space-between","align-items":"center"}},X=["innerHTML"],J={name:"Flash"},Q=N({...J,setup(Y){const d=A(),e=O({status:"\u70B9\u51FB\u66F4\u65B0\u6309\u94AE\u66F4\u65B0\u56FA\u4EF6\u5230\u8BBE\u5907<br/><br/>",binaryFile:void 0,binaryName:"",protocol:"Official"}),l=q();I(async()=>{var t;if(l.query.url){const o=await fetch(l.query.url),a=(t=o==null?void 0:o.body)==null?void 0:t.getReader();if(a){const r=[];for(;;){const{done:n,value:p}=await a.read();if(n)break;r.push(...p)}const u=new Uint8Array(r);e.binaryFile=u,e.binaryName=l.query.url.substring(l.query.url.lastIndexOf("/")+1).split("?")[0]+" "}}});const h=()=>{const t=document.createElement("input");t.type="file",t.onchange=async()=>{const o=new Blob([t.files[0]],{type:"application/octet-stream"}),a=new Uint8Array(await o.arrayBuffer());e.binaryFile=a,e.binaryName=t.files[0].name},t.click()},g=async()=>{if(!e.binaryFile){alert("\u8BF7\u9009\u62E9\u6587\u4EF6");return}d.connectPort&&await y(d.connectPort);let t=await G();e.protocol=="Official"&&await m(t,24,1e3),e.protocol=="Official"&&(await F(t,[48,5,16,0,42,79,69,70,87,45,76,79,83,69,72,85,0,0,0,0]),await m(t,24));const o=L(e.binaryFile);if(o.length>61440)throw alert("\u6700\u540E\u7684\u8FB9\u754C\u68C0\u67E5\u5931\u8D25\u3002\u4E0D\u7BA1\u662F\u8C01\u4FEE\u6539\u4E86\u4EE3\u7801\uFF0C\u4ED6\u90FD\u662F\u4E2A\u767D\u75F4\u3002"),new Error("Last resort boundary check failed. Whoever touched the code is an idiot.");for(let a=0;a<o.length;a+=256){const r=o.slice(a,a+256),u=U(r,a,o.length);try{await F(t,u),e.protocol=="Official"?await m(t,26):await W(t)}catch(n){return console.log("Flash command rejected. Aborting."),Promise.reject(n)}e.status=e.status+`\u66F4\u65B0\u8FDB\u5EA6 ${(a/o.length*100).toFixed(1)}%<br/>`,b(()=>{const n=document==null?void 0:document.getElementById("statusArea");n&&(n.scrollTop=n==null?void 0:n.scrollHeight)})}e.status=e.status+"\u66F4\u65B0\u8FDB\u5EA6 100.0%<br/>",e.status=e.status+"\u56FA\u4EF6\u66F4\u65B0\u6210\u529F",b(()=>{const a=document==null?void 0:document.getElementById("statusArea");a&&(a.scrollTop=a==null?void 0:a.scrollHeight)}),y(t),d.updateSettings({connectState:!1})};return(t,o)=>{const a=C,r=R,u=S,n=P,p=T,w=H,E=V,B=M,v=j;return $(),x("div",z,[s(a,{items:[t.$t("menu.list"),t.$t("menu.flash")]},null,8,["items"]),s(v,{gutter:20,align:"stretch"},{default:i(()=>[s(B,{span:24},{default:i(()=>[s(E,{class:"general-card",title:t.$t("menu.flash")+t.$t("global.onBoot")},{default:i(()=>[c("div",K,[c("div",null,[s(u,null,{default:i(()=>[s(r,{onClick:h},{default:i(()=>[f(_(e.binaryFile?e.binaryName:t.$t("tool.selectFirmware")),1)]),_:1}),s(r,{type:"primary",disabled:!e.binaryFile,onClick:g},{default:i(()=>[f(_(t.$t("tool.flash")),1)]),_:1},8,["disabled"])]),_:1})]),c("div",null,[s(p,{type:"button",size:"mini",modelValue:e.protocol,"onUpdate:modelValue":o[0]||(o[0]=k=>e.protocol=k)},{default:i(()=>[s(n,{value:"Official"},{default:i(()=>[f("Official")]),_:1})]),_:1},8,["modelValue"])])]),s(w),c("div",{id:"statusArea",style:{height:"20em","background-color":"var(--color-bg-3)",color:"var(--color-text-3)",overflow:"auto",padding:"20px"},innerHTML:e.status},null,8,X)]),_:1},8,["title"])]),_:1})]),_:1})])}}});const lt=D(Q,[["__scopeId","data-v-f272bde7"]]);export{lt as default};
