import{v as T,t as V,ad as U,_ as N}from"./index.38892ecc.js";/* empty css              *//* empty css              *//* empty css               *//* empty css               *//* empty css               *//* empty css               *//* empty css              *//* empty css               */import{d as M,j as R,r as P,w as I,aY as $,b3 as K,bT as H,bI as Z,C as x,D as b,aI as a,aH as r,aM as c,G as l,aN as h,aK as j,aJ as q,aE as G,c3 as J,b7 as O,bh as Y,bf as z,b8 as Q,bV as W,bm as X,bn as ee,n as te}from"./arco.13f9ef32.js";import{n as ne,e as se,o as oe}from"./serial.d615852e.js";import{g as ae}from"./vue.eb9ee7d7.js";import"./chart.5acd6cf6.js";const A=_=>(X("data-v-40973ff9"),_=_(),ee(),_),re={class:"container"},ce={style:{display:"flex","align-items":"center",margin:"10px"}},ie=A(()=>l("span",null,"\u547C\u53F7\uFF1A",-1)),le=A(()=>l("span",null,"\u8BBE\u5907\u53F7\uFF1A",-1)),ue={style:{height:"500px",border:"1px solid #eee"}},de={style:{display:"flex"}},pe={style:{width:"100px","text-align":"right","margin-right":"10px"}},me={style:{"margin-left":"10px"}},_e={name:"Chat"},ge=M({..._e,setup(_){T.exports.useI18n();const S=ae(),g=V(),f=R(null),e=P({sendInput:"",msgList:[],callsign:sessionStorage.getItem("callsign")||"",devid:parseInt(sessionStorage.getItem("devid")||"0"),connect:!1,reader:null,startChat:"\u5F00\u59CB\u804A\u5929"});I(()=>e.callsign,(n,t)=>{sessionStorage.setItem("callsign",n)}),I(()=>e.devid,(n,t)=>{sessionStorage.setItem("devid",n.toString())}),$(()=>{e.connect&&e.reader.releaseLock()});const C=n=>/^[A-Z]{1,2}\d{1,2}[A-Z]{1,3}$/.test(n),v=()=>{te(()=>{f.value&&(f.value.$el.children[0].children[0].children[0].scrollTop=f.value.$el.children[0].children[0].children[0].scrollHeight)})},k=()=>{S.push({path:"/tool/flash",query:{url:"/sms_test.bin"}})};function w(n){const u=new TextEncoder().encode(n);let s="";return u.forEach(i=>{s+=i.toString(16).padStart(2,"0").toUpperCase()}),s}function B(n){const t=new Uint8Array(n.match(/.{1,2}/g).map(s=>parseInt(s,16)));return new TextDecoder().decode(t)}const y=async()=>{if(e.sendInput.trim()!=""){if(!C(e.callsign.trim())){O.error("\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u547C\u53F7");return}ne(g.connectPort,"START:"+e.callsign.trim()+":"+e.devid+":"+w(e.sendInput.trim())+":END"),e.msgList.push({callsign:e.callsign.trim(),devid:e.devid,content:e.sendInput.trim()}),e.sendInput="",v()}},E=async()=>{if(e.connect)e.connect=!1,e.reader.releaseLock(),e.startChat="\u5F00\u59CB\u804A\u5929";else{if(g.connectState!=!0){alert(sessionStorage.getItem("noticeConnectK5"));return}await se(g.connectPort),e.reader=oe(g.connectPort),D(e.reader),e.startChat="\u65AD\u5F00\u804A\u5929",e.connect=!0}},D=async n=>{let t="";const u=new TextDecoder,s=/START:[A-Z0-9]+:[0-9]+:[A-F0-9]+:END/g;for(;;)try{const{value:i,done:F}=await n.read();if(F)break;let p=u.decode(i,{stream:!0});p=p.trim(),t+=p,console.log(t);const d=t.match(s);if(d&&d.length>0){t="";try{const m=d[d.length-1].split(":");e.msgList.push({callsign:m[1],devid:m[2],content:B(m[3])}),v()}catch{console.log("ERROR")}}}catch{console.log("\u5DF2\u65AD\u5F00"),e.connect=!1,e.reader.releaseLock(),e.startChat="\u5F00\u59CB\u804A\u5929";break}n.releaseLock()};return(n,t)=>{const u=U,s=Y,i=z,F=K,p=Q,d=W,m=H,L=Z;return x(),b("div",re,[a(u,{items:[n.$t("menu.list"),n.$t("menu.flash")]},null,8,["items"]),a(L,{class:"general-card"},{title:r(()=>[c(" \u3010\u65E0\u6CD5\u6B63\u5E38\u4F7F\u7528\u3011\u3010\u5F00\u53D1\u4E2D\uFF01\uFF01\uFF01\u3011\u65E0\u7EBF\u7535\u804A\u5929\uFF08\u9700\u4F7F\u7528"),a(s,{onClick:k},{default:r(()=>[c("\u8FD9\u4E2A")]),_:1}),c("\u56FA\u4EF6\uFF09 ")]),default:r(()=>[l("div",ce,[ie,a(i,{modelValue:e.callsign,"onUpdate:modelValue":t[0]||(t[0]=o=>e.callsign=o),style:{width:"200px !important"}},null,8,["modelValue"]),c(" \xA0\xA0\xA0 "),le,a(F,{min:0,max:15,modelValue:e.devid,"onUpdate:modelValue":t[1]||(t[1]=o=>e.devid=o),style:{width:"200px !important"}},null,8,["modelValue"]),c(" \xA0\xA0\xA0 "),a(p,{onClick:E,type:"primary"},{default:r(()=>[c(h(e.startChat),1)]),_:1})]),l("div",ue,[a(m,{"max-height":500,bordered:!1,ref_key:"msgList",ref:f},{empty:r(()=>[]),default:r(()=>[(x(!0),b(j,null,q(e.msgList,o=>(x(),G(d,null,{default:r(()=>[l("div",de,[l("div",pe,h(o.callsign)+"("+h(o.devid.toString().padStart(2,"0"))+")",1),c(" > "),l("div",me,h(o.content),1)])]),_:2},1024))),256))]),_:1},512)]),a(i,{disabled:!e.connect,modelValue:e.sendInput,"onUpdate:modelValue":t[2]||(t[2]=o=>e.sendInput=o),onKeyup:J(y,["enter"])},{append:r(()=>[a(s,{disabled:!e.connect,onClick:y},{default:r(()=>[c("\u53D1\u9001")]),_:1},8,["disabled"])]),_:1},8,["disabled","modelValue"])]),_:1})])}}});const Be=N(ge,[["__scopeId","data-v-40973ff9"]]);export{Be as default};
