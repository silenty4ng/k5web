import{d as T,g as V,_ as U}from"./index.884a5cbc.js";import{a2 as M,$ as N,b as P,a3 as R,P as $,M as K,d as Z,a5 as H}from"./@arco-design.95e0b031.js";import"./vue.24dcbee8.js";import{n as j,e as q,o as z}from"./serial.d615852e.js";import{b as O}from"./vue-router.425aabc5.js";import{d as Q,r as G,h as J,w as A,m as W,o as x,a as I,x as r,u as a,z as i,e as l,A as h,F as X,Q as Y,s as ee,S as te,b9 as ne,b8 as oe,D as se}from"./@vue.2faf1d8e.js";import{v as re}from"./vue-i18n.4b9acc8b.js";import"./vue-echarts.29561399.js";import"./resize-detector.a8854a64.js";import"./echarts.5b0e6023.js";import"./zrender.ce26131e.js";import"./tslib.c6ba9914.js";import"./nprogress.77f16b3e.js";import"./@intlify.b8ed1d74.js";import"./mitt.550594b0.js";import"./pinia.510425a1.js";import"./vue-demi.1e0b7689.js";import"./axios.234ce069.js";import"./@vueuse.c5c16882.js";import"./aegis-web-sdk.088ecaea.js";import"./@zxing.8654f0db.js";import"./tdesign-vue-next.62a9d0ce.js";import"./tdesign-icons-vue-next.514651cc.js";import"./sortablejs.b2e3c7c4.js";import"./@popperjs.f3f73334.js";import"./vue-matomo.ed94ba67.js";import"./b-tween.8dd4e2fe.js";import"./dayjs.08dc07e5.js";import"./b-validate.1fdaeb97.js";import"./number-precision.5cddbed2.js";import"./resize-observer-polyfill.2b976e6e.js";import"./scroll-into-view-if-needed.0a5da943.js";import"./compute-scroll-into-view.17358474.js";const S=_=>(ne("data-v-40973ff9"),_=_(),oe(),_),ae={class:"container"},ie={style:{display:"flex","align-items":"center",margin:"10px"}},ce=S(()=>l("span",null,"\u547C\u53F7\uFF1A",-1)),le=S(()=>l("span",null,"\u8BBE\u5907\u53F7\uFF1A",-1)),ue={style:{height:"500px",border:"1px solid #eee"}},de={style:{display:"flex"}},pe={style:{width:"100px","text-align":"right","margin-right":"10px"}},me={style:{"margin-left":"10px"}},_e={name:"Chat"},ge=Q({..._e,setup(_){re.exports.useI18n();const C=O(),g=T(),f=G(null),e=J({sendInput:"",msgList:[],callsign:sessionStorage.getItem("callsign")||"",devid:parseInt(sessionStorage.getItem("devid")||"0"),connect:!1,reader:null,startChat:"\u5F00\u59CB\u804A\u5929"});A(()=>e.callsign,(n,t)=>{sessionStorage.setItem("callsign",n)}),A(()=>e.devid,(n,t)=>{sessionStorage.setItem("devid",n.toString())}),W(()=>{e.connect&&e.reader.releaseLock()});const b=n=>/^[A-Z]{1,2}\d{1,2}[A-Z]{1,3}$/.test(n),v=()=>{se(()=>{f.value&&(f.value.$el.children[0].children[0].children[0].scrollTop=f.value.$el.children[0].children[0].children[0].scrollHeight)})},k=()=>{C.push({path:"/tool/flash",query:{url:"/sms_test.bin"}})};function w(n){const u=new TextEncoder().encode(n);let o="";return u.forEach(c=>{o+=c.toString(16).padStart(2,"0").toUpperCase()}),o}function B(n){const t=new Uint8Array(n.match(/.{1,2}/g).map(o=>parseInt(o,16)));return new TextDecoder().decode(t)}const y=async()=>{if(e.sendInput.trim()!=""){if(!b(e.callsign.trim())){K.error("\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u547C\u53F7");return}j(g.connectPort,"START:"+e.callsign.trim()+":"+e.devid+":"+w(e.sendInput.trim())+":END"),e.msgList.push({callsign:e.callsign.trim(),devid:e.devid,content:e.sendInput.trim()}),e.sendInput="",v()}},E=async()=>{if(e.connect)e.connect=!1,e.reader.releaseLock(),e.startChat="\u5F00\u59CB\u804A\u5929";else{if(g.connectState!=!0){alert(sessionStorage.getItem("noticeConnectK5"));return}await q(g.connectPort),e.reader=z(g.connectPort),D(e.reader),e.startChat="\u65AD\u5F00\u804A\u5929",e.connect=!0}},D=async n=>{let t="";const u=new TextDecoder,o=/START:[A-Z0-9]+:[0-9]+:[A-F0-9]+:END/g;for(;;)try{const{value:c,done:F}=await n.read();if(F)break;let p=u.decode(c,{stream:!0});p=p.trim(),t+=p,console.log(t);const d=t.match(o);if(d&&d.length>0){t="";try{const m=d[d.length-1].split(":");e.msgList.push({callsign:m[1],devid:m[2],content:B(m[3])}),v()}catch{console.log("ERROR")}}}catch{console.log("\u5DF2\u65AD\u5F00"),e.connect=!1,e.reader.releaseLock(),e.startChat="\u5F00\u59CB\u804A\u5929";break}n.releaseLock()};return(n,t)=>{const u=V,o=M,c=N,F=P,p=Z,d=H,m=R,L=$;return x(),I("div",ae,[r(u,{items:[n.$t("menu.list"),n.$t("menu.flash")]},null,8,["items"]),r(L,{class:"general-card"},{title:a(()=>[i(" \u3010\u65E0\u6CD5\u6B63\u5E38\u4F7F\u7528\u3011\u3010\u5F00\u53D1\u4E2D\uFF01\uFF01\uFF01\u3011\u65E0\u7EBF\u7535\u804A\u5929\uFF08\u9700\u4F7F\u7528"),r(o,{onClick:k},{default:a(()=>[i("\u8FD9\u4E2A")]),_:1}),i("\u56FA\u4EF6\uFF09 ")]),default:a(()=>[l("div",ie,[ce,r(c,{modelValue:e.callsign,"onUpdate:modelValue":t[0]||(t[0]=s=>e.callsign=s),style:{width:"200px !important"}},null,8,["modelValue"]),i(" \xA0\xA0\xA0 "),le,r(F,{min:0,max:15,modelValue:e.devid,"onUpdate:modelValue":t[1]||(t[1]=s=>e.devid=s),style:{width:"200px !important"}},null,8,["modelValue"]),i(" \xA0\xA0\xA0 "),r(p,{onClick:E,type:"primary"},{default:a(()=>[i(h(e.startChat),1)]),_:1})]),l("div",ue,[r(m,{"max-height":500,bordered:!1,ref_key:"msgList",ref:f},{empty:a(()=>[]),default:a(()=>[(x(!0),I(X,null,Y(e.msgList,s=>(x(),ee(d,null,{default:a(()=>[l("div",de,[l("div",pe,h(s.callsign)+"("+h(s.devid.toString().padStart(2,"0"))+")",1),i(" > "),l("div",me,h(s.content),1)])]),_:2},1024))),256))]),_:1},512)]),r(c,{disabled:!e.connect,modelValue:e.sendInput,"onUpdate:modelValue":t[2]||(t[2]=s=>e.sendInput=s),onKeyup:te(y,["enter"])},{append:a(()=>[r(o,{disabled:!e.connect,onClick:y},{default:a(()=>[i("\u53D1\u9001")]),_:1},8,["disabled"])]),_:1},8,["disabled","modelValue"])]),_:1})])}}});const Ge=U(ge,[["__scopeId","data-v-40973ff9"]]);export{Ge as default};
