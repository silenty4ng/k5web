import{d as J,g as K,_ as Q}from"./index.83ff881e.js";import{U as G,_ as X,d as Y,k as Z,W as ee,a0 as te}from"./@arco-design.1f9a81c2.js";import"./vue.daf89c07.js";import{u as oe}from"./loading.bfb45974.js";import{i as ae,e as ne,s as C,h as B,g as re,k as le,b as se,a as ie}from"./serial.0b46e76d.js";import{L as ce,B as ue,I as de,o as pe,S as me}from"./tdesign-vue-next.876353e4.js";import{d as ge,h as fe,l as _e,o as y,a as k,x as c,u as s,e as g,z as d,A as m,F as S,Q as N,b as $,s as he,_ as be,b9 as ye,b8 as we,D as Fe}from"./@vue.1cdd4af7.js";import"./vue-router.391082ef.js";import"./nprogress.b0a22fe3.js";import"./@intlify.d4358f23.js";import"./mitt.550594b0.js";import"./pinia.722f5e0f.js";import"./vue-demi.0f54e832.js";import"./axios.f3f20840.js";import"./vue-i18n.645f4f0b.js";import"./@vueuse.3623d212.js";import"./aegis-web-sdk.846094f8.js";import"./@zxing.8654f0db.js";import"./vue-matomo.4c7efa96.js";import"./b-tween.8dd4e2fe.js";import"./dayjs.f7934723.js";import"./b-validate.1fdaeb97.js";import"./number-precision.5cddbed2.js";import"./resize-observer-polyfill.2b976e6e.js";import"./scroll-into-view-if-needed.0a5da943.js";import"./compute-scroll-into-view.17358474.js";import"./lodash-es.18922ecc.js";import"./tdesign-icons-vue-next.5ef165be.js";import"./sortablejs.b2e3c7c4.js";import"./@popperjs.f3f73334.js";import"./@babel.9b6013fe.js";const M=w=>(ye("data-v-7f8ac41e"),w=w(),we(),w),ve={class:"container"},ke={style:{color:"red","font-weight":"bold"}},Ae={style:{"font-size":"0.9rem"}},Ee={style:{display:"flex","justify-content":"space-between","margin-left":"10px","margin-right":"10px","align-items":"flex-end","margin-bottom":"3px"}},xe=M(()=>g("div",null,"EEPROM\uFF1A",-1)),Ce={style:{width:"100%",overflow:"scroll","user-select":"none"}},Be={style:{height:"328px",display:"flex","flex-direction":"column",margin:"0",padding:"0","flex-wrap":"wrap"}},Se=["onClick","ondragover","ondrop","title"],Ne=M(()=>g("br",null,null,-1)),$e=["innerHTML"],Me={name:"BL"},Ue=ge({...Me,setup(w){const f=J(),{loading:U,setLoading:F}=oe(!0),t=fe({calendar:[],rom:[],bl:void 0,blName:"",nowDrag:-1,showAdd:"",status:""}),D=(e,o)=>e.length!==o.length?!1:e.every((n,r)=>n===o[r]),h=async(e=0,o,n="")=>{var r,i;for(let a=e;a<o.length+e;a+=64){await se(f.connectPort,a,o.slice(a-e,a-e+64),o.slice(a-e,a-e+64).length,(r=f.configuration)==null?void 0:r.uart);const u=await ie(f.connectPort,a,o.slice(a-e,a-e+64).length,(i=f.configuration)==null?void 0:i.uart);if(!D(o.slice(a-e,a-e+64),u)){t.status=t.status+n+"\u68C0\u6D4B\u5230\u5199\u5165\u9519\u8BEF\uFF01\uFF01\uFF01<br/>",a-=64;continue}t.status=t.status+n+"\u5199\u5165\u8FDB\u5EA6\uFF1A"+((a-e)/o.length*100).toFixed(1)+"%<br/>",Fe(()=>{const p=document==null?void 0:document.getElementById("statusArea");p&&(p.scrollTop=p==null?void 0:p.scrollHeight)})}},P=async e=>{t.showAdd=(e*64+262144).toString(16).toUpperCase(),setTimeout(()=>{t.showAdd=""},5e3)};_e(()=>{I();const e=[];for(let o=0;o<262144/64;o++)o<278528/64/16-16?e.push(-2):e.push(-1);t.calendar=e});const I=async()=>{const e=JSON.parse(await(await fetch("https://k5.vicicode.cn/diyapi/bl.json")).text()).latest;t.blName=e;const o=await fetch("https://k5.vicicode.cn/diyapi/"+e);if(o.body){const n=o.body.getReader(),r=[];for(;;){const{done:a,value:u}=await n.read();if(a)break;r.push(...u)}let i=new Uint8Array(12288);i.set(r,0),t.bl=i,F(!1)}},L=async()=>{var i;if(f.connectState!=!0){alert(sessionStorage.getItem("noticeConnectK5"));return}const e=await ae(f.connectPort,(i=f.configuration)==null?void 0:i.uart);if(F(!0),e<524288){alert("\u53EA\u652F\u6301 4Mbit \u4EE5\u4E0A EEPROM \u5199\u5165"),F(!1);return}await ne(f.connectPort),await h(266240,t.bl,"\u5F15\u5BFC\u7A0B\u5E8F");const o=[];for(let a=256;a<4096;a++)if(t.calendar[a]>=0){console.log(a);const u=new Uint8Array(Math.ceil(t.rom[t.calendar[a]].binaryFile.length/64)*64).fill(255);u.set(t.rom[t.calendar[a]].binaryFile,0),t.rom[t.calendar[a]].binaryFile=u,o.push({...t.rom[t.calendar[a]],start:262144+a*64,end:262144+(a+Math.ceil(t.rom[t.calendar[a]].binaryFile.length/64))*64-1}),a+=Math.ceil(t.rom[t.calendar[a]].binaryFile.length/64)-1}await h(262144,new Uint8Array([o.length]),"\u56FA\u4EF6\u6570\u91CF");const n=new Uint8Array(8);n.set(C(t.blName.split(".")[0])),await h(262152,n,"\u5F15\u5BFC\u7A0B\u5E8F\u7248\u672C");const r=[];o.map(a=>{const u=new Uint8Array(16),p=new Uint8Array(4),v=new Uint8Array(4);u.set(C(a.binaryName.replace(/[^\x00-\xff]/g,""))),p.set(B(a.start.toString(16))),v.set(B(a.end.toString(16))),r.push(...u,...p,...v,...new Uint8Array(8))}),await h(262176,r,"\u56FA\u4EF6\u5143\u6570\u636E");for(let a=0;a<o.length;a++)await h(o[a].start,o[a].binaryFile,o[a].binaryName+" \u56FA\u4EF6\u6587\u4EF6");await re(f.connectPort),t.status=t.status+"\u5199\u5165\u5B8C\u6210<br/>",F(!1)},T=()=>{const e=document.createElement("input");e.type="file",e.multiple=!0,e.onchange=async()=>{if(e.files)for(let o=0;o<e.files.length;o++){const n=new Blob([e.files[o]],{type:"application/octet-stream"}),r=new Uint8Array(await n.arrayBuffer()),i={binaryFile:le(r),binaryName:e.files[o].name.replace(/[^\x00-\xff]/g,""),color:R()};t.rom.push(i)}},e.click()},V=(e,o)=>{if(!(o<256)&&!(o+Math.ceil(t.rom[t.nowDrag].binaryFile.length/64)>4096)&&e!=2){for(let n=o;n<o+Math.ceil(t.rom[t.nowDrag].binaryFile.length/64);n+=1)A(n);for(let n=o;n<o+Math.ceil(t.rom[t.nowDrag].binaryFile.length/64);n+=1)t.calendar[n]=t.nowDrag;console.log((o*64+262144).toString(16)),console.log((Math.ceil(t.rom[t.nowDrag].binaryFile.length/64)*64+(o*64+262144)-1).toString(16))}},R=()=>{for(var e="0123456789ABCDEF",o="#",n=0;n<6;n++)o+=e[Math.floor(Math.random()*16)];return o},A=e=>{if(e>4095||e<256)return;let o=0;t.calendar[e]!=-1&&(o=1,t.calendar[e]=-1),o&&(t.calendar[e-1]!=-1&&A(e-1),t.calendar[e+1]!=-1&&A(e+1))},E=e=>{if(e>4095||e<256)return;let o=-99;t.calendar[e]!=-1&&(o=t.calendar[e],t.calendar[e]=-1),t.calendar[e-1]===o&&E(e-1),t.calendar[e+1]===o&&E(e+1)},x=e=>{e>4095||e<256||(t.calendar[e]=-1,x(e+1))},z=e=>{t.rom[e].binaryName=t.rom[e].binaryName.replace(/[^\x00-\xff]/g,"")};return(e,o)=>{const n=K,r=ce,i=X,a=Y,u=Z,p=ee,v=te,O=ue,H=de,j=pe,W=me,q=G;return y(),k("div",ve,[c(n,{items:[e.$t("menu.list"),e.$t("bl")]},null,8,["items"]),c(q,{class:"general-card",loading:be(U)},{title:s(()=>[g("div",ke,[d(m(e.$t("bl.warning"))+" ",1),g("span",Ae,[d("\u3010"+m(e.$t("bl.readme")),1),c(r,{theme:"primary",href:"https://github.com/losehu/uv-k5-bootloader-custom/releases",target:"_blank"},{default:s(()=>[d("https://github.com/losehu/uv-k5-bootloader-custom/releases")]),_:1}),d("\u3011")])]),d(" "+m(e.$t("bl"))+" "+m(e.$t("global.onStart")),1)]),default:s(()=>[c(v,{style:{"margin-bottom":"16px"}},{default:s(()=>[c(p,{span:12},{default:s(()=>[c(u,{style:{width:"130%"}},{default:s(()=>[c(a,{onClick:L},{icon:s(()=>[c(i)]),default:s(()=>[d(" "+m(e.$t("cps.onDeviceWrite")),1)]),_:1}),d(" \uFF08"+m(e.$t("bl.onlyEnglish"))+"\uFF09 ",1)]),_:1})]),_:1})]),_:1}),g("div",Ee,[xe,g("div",null,[d(m(t.showAdd)+" ",1),c(O,{size:"small",variant:"outline",onClick:o[0]||(o[0]=l=>x(256))},{default:s(()=>[d(m(e.$t("bl.clear")),1)]),_:1})])]),g("div",Ce,[g("div",Be,[(y(!0),k(S,null,N(t.calendar,(l,_)=>(y(),k("div",{onClick:b=>E(_),ondragover:b=>{P(_),b.preventDefault()},ondrop:()=>{V(l,_)},title:l==-2?e.$t("bl.bootloader"):l!=-1?t.rom[l].binaryName:(_*64+262144).toString(16).toUpperCase()+" - "+(_*64+262144+63).toString(16).toUpperCase(),style:$(l==-1?"background-color: white; border: 1px solid #ddd; height: 10px;":l==-2?"background-color: #373737; border: 1px solid #ddd; height: 10px;":"background-color: "+t.rom[l].color+"; border: 1px solid #ddd; height: 10px;"),key:_}," \xA0 ",12,Se))),128))])]),c(a,{style:{"margin-bottom":"10px"},onClick:T},{default:s(()=>[d(m(t.binaryFile?t.binaryName:e.$t("tool.selectFirmware")),1)]),_:1}),d("\uFF08"+m(e.$t("bl.drag"))+"\uFF09 ",1),Ne,c(W,{"break-line":""},{default:s(()=>[(y(!0),k(S,null,N(t.rom,(l,_)=>(y(),he(j,{draggable:"true",ondragstart:()=>{t.nowDrag=_},title:l.binaryName,bordered:!0,"hover-shadow":"",style:{width:"400px"}},{actions:s(()=>[g("div",{style:$("width: 10px; height: 10px; background-color: "+l.color+";")},null,4)]),default:s(()=>[c(H,{modelValue:l.binaryName,"onUpdate:modelValue":b=>l.binaryName=b,onChange:b=>z(_),"show-limit-number":"",maxlength:13},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["ondragstart","title"]))),256))]),_:1})]),_:1},8,["loading"]),g("div",{id:"statusArea",style:{height:"20em","background-color":"var(--color-bg-3)",color:"var(--color-text-3)",overflow:"auto",padding:"20px","margin-top":"10px"},innerHTML:t.status},null,8,$e)])}}});const dt=Q(Ue,[["__scopeId","data-v-7f8ac41e"]]);export{dt as default};
