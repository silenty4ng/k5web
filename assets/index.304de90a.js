import{d as D,g as L,_ as T}from"./index.03915ce6.js";import{a2 as V,$ as U,b as M,a3 as N,P,M as R,d as $,a5 as K}from"./@arco-design.10d71e42.js";import"./vue.ffb667bf.js";import{n as Z,e as H,o as j}from"./serial.0b46e76d.js";import{b as q}from"./vue-router.a9f5d186.js";import{d as z,r as O,h as Q,w as A,m as G,o as x,a as h,x as r,u as a,z as i,b as u,A as _,F as J,Q as W,s as X,S as Y,D as tt}from"./@vue.6ceb3fa6.js";import{v as et}from"./vue-i18n.5fb6db72.js";import"./nprogress.6328d444.js";import"./@intlify.02b6985d.js";import"./mitt.550594b0.js";import"./pinia.fa8b6be2.js";import"./vue-demi.0e7683c7.js";import"./axios.06033baf.js";import"./tdesign-vue-next.ed813ef2.js";import"./lodash-es.18922ecc.js";import"./sortablejs.77296005.js";import"./@popperjs.f3f73334.js";import"./@babel.9b6013fe.js";import"./dayjs.35d19ede.js";import"./@vueuse.a7db99fe.js";import"./@zxing.8654f0db.js";import"./@microsoft.d2aaf3b7.js";import"./vue-matomo.5bdfe9a5.js";import"./b-tween.8dd4e2fe.js";import"./b-validate.1fdaeb97.js";import"./number-precision.5cddbed2.js";import"./resize-observer-polyfill.2b976e6e.js";import"./scroll-into-view-if-needed.0a5da943.js";import"./compute-scroll-into-view.17358474.js";const nt={class:"container"},ot={style:{display:"flex","align-items":"center",margin:"10px"}},st={style:{height:"500px",border:"1px solid #eee"}},rt={style:{display:"flex"}},at={style:{width:"100px","text-align":"right","margin-right":"10px"}},it={style:{"margin-left":"10px"}},lt={name:"Chat"},ut=z({...lt,setup(dt){et.exports.useI18n();const I=q(),g=D(),f=O(null),e=Q({sendInput:"",msgList:[],callsign:sessionStorage.getItem("callsign")||"",devid:parseInt(sessionStorage.getItem("devid")||"0"),connect:!1,reader:null,startChat:"\u5F00\u59CB\u804A\u5929"});A(()=>e.callsign,(n,t)=>{sessionStorage.setItem("callsign",n)}),A(()=>e.devid,(n,t)=>{sessionStorage.setItem("devid",n.toString())}),G(()=>{e.connect&&e.reader.releaseLock()});const S=n=>/^[A-Z]{1,2}\d{1,2}[A-Z]{1,3}$/.test(n),v=()=>{tt(()=>{f.value&&(f.value.$el.children[0].children[0].children[0].scrollTop=f.value.$el.children[0].children[0].children[0].scrollHeight)})},C=()=>{I.push({path:"/tool/flash",query:{url:"/sms_test.bin"}})};function b(n){const d=new TextEncoder().encode(n);let o="";return d.forEach(l=>{o+=l.toString(16).padStart(2,"0").toUpperCase()}),o}function k(n){const t=new Uint8Array(n.match(/.{1,2}/g).map(o=>parseInt(o,16)));return new TextDecoder().decode(t)}const y=async()=>{if(e.sendInput.trim()!=""){if(!S(e.callsign.trim())){R.error("\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u547C\u53F7");return}Z(g.connectPort,"START:"+e.callsign.trim()+":"+e.devid+":"+b(e.sendInput.trim())+":END"),e.msgList.push({callsign:e.callsign.trim(),devid:e.devid,content:e.sendInput.trim()}),e.sendInput="",v()}},w=async()=>{if(e.connect)e.connect=!1,e.reader.releaseLock(),e.startChat="\u5F00\u59CB\u804A\u5929";else{if(g.connectState!=!0){alert(sessionStorage.getItem("noticeConnectK5"));return}await H(g.connectPort),e.reader=j(g.connectPort),B(e.reader),e.startChat="\u65AD\u5F00\u804A\u5929",e.connect=!0}},B=async n=>{let t="";const d=new TextDecoder,o=/START:[A-Z0-9]+:[0-9]+:[A-F0-9]+:END/g;for(;;)try{const{value:l,done:F}=await n.read();if(F)break;let m=d.decode(l,{stream:!0});m=m.trim(),t+=m,console.log(t);const c=t.match(o);if(c&&c.length>0){t="";try{const p=c[c.length-1].split(":");e.msgList.push({callsign:p[1],devid:p[2],content:k(p[3])}),v()}catch{console.log("ERROR")}}}catch{console.log("\u5DF2\u65AD\u5F00"),e.connect=!1,e.reader.releaseLock(),e.startChat="\u5F00\u59CB\u804A\u5929";break}n.releaseLock()};return(n,t)=>{const d=L,o=V,l=U,F=M,m=$,c=K,p=N,E=P;return x(),h("div",nt,[r(d,{items:[n.$t("menu.list"),n.$t("menu.flash")]},null,8,["items"]),r(E,{class:"general-card"},{title:a(()=>[t[4]||(t[4]=i(" \u3010\u65E0\u6CD5\u6B63\u5E38\u4F7F\u7528\u3011\u3010\u5F00\u53D1\u4E2D\uFF01\uFF01\uFF01\u3011\u65E0\u7EBF\u7535\u804A\u5929\uFF08\u9700\u4F7F\u7528",-1)),r(o,{onClick:C},{default:a(()=>[...t[3]||(t[3]=[i("\u8FD9\u4E2A",-1)])]),_:1}),t[5]||(t[5]=i("\u56FA\u4EF6\uFF09 ",-1))]),default:a(()=>[u("div",ot,[t[6]||(t[6]=u("span",null,"\u547C\u53F7\uFF1A",-1)),r(l,{modelValue:e.callsign,"onUpdate:modelValue":t[0]||(t[0]=s=>e.callsign=s),style:{width:"200px !important"}},null,8,["modelValue"]),t[7]||(t[7]=i(" \xA0\xA0\xA0 ",-1)),t[8]||(t[8]=u("span",null,"\u8BBE\u5907\u53F7\uFF1A",-1)),r(F,{min:0,max:15,modelValue:e.devid,"onUpdate:modelValue":t[1]||(t[1]=s=>e.devid=s),style:{width:"200px !important"}},null,8,["modelValue"]),t[9]||(t[9]=i(" \xA0\xA0\xA0 ",-1)),r(m,{onClick:w,type:"primary"},{default:a(()=>[i(_(e.startChat),1)]),_:1})]),u("div",st,[r(p,{"max-height":500,bordered:!1,ref_key:"msgList",ref:f},{empty:a(()=>[...t[10]||(t[10]=[])]),default:a(()=>[(x(!0),h(J,null,W(e.msgList,s=>(x(),X(c,null,{default:a(()=>[u("div",rt,[u("div",at,_(s.callsign)+"("+_(s.devid.toString().padStart(2,"0"))+")",1),t[11]||(t[11]=i(" > ",-1)),u("div",it,_(s.content),1)])]),_:2},1024))),256))]),_:1},512)]),r(l,{disabled:!e.connect,modelValue:e.sendInput,"onUpdate:modelValue":t[2]||(t[2]=s=>e.sendInput=s),onKeyup:Y(y,["enter"])},{append:a(()=>[r(o,{disabled:!e.connect,onClick:y},{default:a(()=>[...t[12]||(t[12]=[i("\u53D1\u9001",-1)])]),_:1},8,["disabled"])]),_:1},8,["disabled","modelValue"])]),_:1})])}}});const $t=T(ut,[["__scopeId","data-v-40973ff9"]]);export{$t as default};
