import{d as q,g as J,_ as K}from"./index.eaca48df.js";import{P as Q,Y as W,d as Y,k as G,U as X,_ as Z}from"./@arco-design.10d71e42.js";import"./vue.ffb667bf.js";import{u as ee}from"./loading.566f8821.js";import{i as te,e as oe,s as x,h as C,g as ne,m as ae,b as re,a as le}from"./serial.b0855796.js";import{L as ie,B as se,I as ce,o as ue,S as de}from"./tdesign-vue-next.ed813ef2.js";import{d as pe,h as me,l as ge,o as y,a as v,x as c,u as i,b as m,z as d,A as g,F as B,Q as S,e as N,s as fe,_ as _e,D as he}from"./@vue.6ceb3fa6.js";import"./vue-router.a9f5d186.js";import"./nprogress.6328d444.js";import"./@intlify.02b6985d.js";import"./mitt.550594b0.js";import"./pinia.fa8b6be2.js";import"./vue-demi.0e7683c7.js";import"./axios.06033baf.js";import"./vue-i18n.5fb6db72.js";import"./@vueuse.a7db99fe.js";import"./@zxing.8654f0db.js";import"./@microsoft.d2aaf3b7.js";import"./vue-matomo.5bdfe9a5.js";import"./b-tween.8dd4e2fe.js";import"./dayjs.35d19ede.js";import"./b-validate.1fdaeb97.js";import"./number-precision.5cddbed2.js";import"./resize-observer-polyfill.2b976e6e.js";import"./scroll-into-view-if-needed.0a5da943.js";import"./compute-scroll-into-view.17358474.js";import"./lodash-es.18922ecc.js";import"./sortablejs.77296005.js";import"./@popperjs.f3f73334.js";import"./@babel.9b6013fe.js";const be={class:"container"},ye={style:{color:"red","font-weight":"bold"}},we={style:{"font-size":"0.9rem"}},Fe={style:{display:"flex","justify-content":"space-between","margin-left":"10px","margin-right":"10px","align-items":"flex-end","margin-bottom":"3px"}},ve={style:{width:"100%",overflow:"scroll","user-select":"none"}},ke={style:{height:"328px",display:"flex","flex-direction":"column",margin:"0",padding:"0","flex-wrap":"wrap"}},Ae=["onClick","ondragover","ondrop","title"],Ee=["innerHTML"],xe={name:"BL"},Ce=pe({...xe,setup(Be){const f=q(),{loading:$,setLoading:w}=ee(!0),o=me({calendar:[],rom:[],bl:void 0,blName:"",nowDrag:-1,showAdd:"",status:""}),M=(e,t)=>e.length!==t.length?!1:e.every((a,r)=>a===t[r]),h=async(e=0,t,a="")=>{var r,s;for(let n=e;n<t.length+e;n+=64){await re(f.connectPort,n,t.slice(n-e,n-e+64),t.slice(n-e,n-e+64).length,(r=f.configuration)==null?void 0:r.uart);const u=await le(f.connectPort,n,t.slice(n-e,n-e+64).length,(s=f.configuration)==null?void 0:s.uart);if(!M(t.slice(n-e,n-e+64),u)){o.status=o.status+a+"\u68C0\u6D4B\u5230\u5199\u5165\u9519\u8BEF\uFF01\uFF01\uFF01<br/>",n-=64;continue}o.status=o.status+a+"\u5199\u5165\u8FDB\u5EA6\uFF1A"+((n-e)/t.length*100).toFixed(1)+"%<br/>",he(()=>{const p=document==null?void 0:document.getElementById("statusArea");p&&(p.scrollTop=p==null?void 0:p.scrollHeight)})}},U=async e=>{o.showAdd=(e*64+262144).toString(16).toUpperCase(),setTimeout(()=>{o.showAdd=""},5e3)};ge(()=>{D();const e=[];for(let t=0;t<262144/64;t++)t<278528/64/16-16?e.push(-2):e.push(-1);o.calendar=e});const D=async()=>{const e=JSON.parse(await(await fetch("https://k5.vicicode.cn/diyapi/bl.json")).text()).latest;o.blName=e;const t=await fetch("https://k5.vicicode.cn/diyapi/"+e);if(t.body){const a=t.body.getReader(),r=[];for(;;){const{done:n,value:u}=await a.read();if(n)break;r.push(...u)}let s=new Uint8Array(12288);s.set(r,0),o.bl=s,w(!1)}},P=async()=>{var s;if(f.connectState!=!0){alert(sessionStorage.getItem("noticeConnectK5"));return}const e=await te(f.connectPort,(s=f.configuration)==null?void 0:s.uart);if(w(!0),e<524288){alert("\u53EA\u652F\u6301 4Mbit \u4EE5\u4E0A EEPROM \u5199\u5165"),w(!1);return}await oe(f.connectPort),await h(266240,o.bl,"\u5F15\u5BFC\u7A0B\u5E8F");const t=[];for(let n=256;n<4096;n++)if(o.calendar[n]>=0){console.log(n);const u=new Uint8Array(Math.ceil(o.rom[o.calendar[n]].binaryFile.length/64)*64).fill(255);u.set(o.rom[o.calendar[n]].binaryFile,0),o.rom[o.calendar[n]].binaryFile=u,t.push({...o.rom[o.calendar[n]],start:262144+n*64,end:262144+(n+Math.ceil(o.rom[o.calendar[n]].binaryFile.length/64))*64-1}),n+=Math.ceil(o.rom[o.calendar[n]].binaryFile.length/64)-1}await h(262144,new Uint8Array([t.length]),"\u56FA\u4EF6\u6570\u91CF");const a=new Uint8Array(8);a.set(x(o.blName.split(".")[0])),await h(262152,a,"\u5F15\u5BFC\u7A0B\u5E8F\u7248\u672C");const r=[];t.map(n=>{const u=new Uint8Array(16),p=new Uint8Array(4),F=new Uint8Array(4);u.set(x(n.binaryName.replace(/[^\x00-\xff]/g,""))),p.set(C(n.start.toString(16))),F.set(C(n.end.toString(16))),r.push(...u,...p,...F,...new Uint8Array(8))}),await h(262176,r,"\u56FA\u4EF6\u5143\u6570\u636E");for(let n=0;n<t.length;n++)await h(t[n].start,t[n].binaryFile,t[n].binaryName+" \u56FA\u4EF6\u6587\u4EF6");await ne(f.connectPort),o.status=o.status+"\u5199\u5165\u5B8C\u6210<br/>",w(!1)},L=()=>{const e=document.createElement("input");e.type="file",e.multiple=!0,e.onchange=async()=>{if(e.files)for(let t=0;t<e.files.length;t++){const a=new Blob([e.files[t]],{type:"application/octet-stream"}),r=new Uint8Array(await a.arrayBuffer()),s={binaryFile:ae(r),binaryName:e.files[t].name.replace(/[^\x00-\xff]/g,""),color:V()};o.rom.push(s)}},e.click()},T=(e,t)=>{if(!(t<256)&&!(t+Math.ceil(o.rom[o.nowDrag].binaryFile.length/64)>4096)&&e!=2){for(let a=t;a<t+Math.ceil(o.rom[o.nowDrag].binaryFile.length/64);a+=1)k(a);for(let a=t;a<t+Math.ceil(o.rom[o.nowDrag].binaryFile.length/64);a+=1)o.calendar[a]=o.nowDrag;console.log((t*64+262144).toString(16)),console.log((Math.ceil(o.rom[o.nowDrag].binaryFile.length/64)*64+(t*64+262144)-1).toString(16))}},V=()=>{for(var e="0123456789ABCDEF",t="#",a=0;a<6;a++)t+=e[Math.floor(Math.random()*16)];return t},k=e=>{if(e>4095||e<256)return;let t=0;o.calendar[e]!=-1&&(t=1,o.calendar[e]=-1),t&&(o.calendar[e-1]!=-1&&k(e-1),o.calendar[e+1]!=-1&&k(e+1))},A=e=>{if(e>4095||e<256)return;let t=-99;o.calendar[e]!=-1&&(t=o.calendar[e],o.calendar[e]=-1),o.calendar[e-1]===t&&A(e-1),o.calendar[e+1]===t&&A(e+1)},E=e=>{e>4095||e<256||(o.calendar[e]=-1,E(e+1))},R=e=>{o.rom[e].binaryName=o.rom[e].binaryName.replace(/[^\x00-\xff]/g,"")};return(e,t)=>{const a=J,r=ie,s=W,n=Y,u=G,p=X,F=Z,I=se,z=ce,O=ue,H=de,j=Q;return y(),v("div",be,[c(a,{items:[e.$t("menu.list"),e.$t("bl")]},null,8,["items"]),c(j,{class:"general-card",loading:_e($)},{title:i(()=>[m("div",ye,[d(g(e.$t("bl.warning"))+" ",1),m("span",we,[d("\u3010"+g(e.$t("bl.readme")),1),c(r,{theme:"primary",href:"https://github.com/losehu/uv-k5-bootloader-custom/releases",target:"_blank"},{default:i(()=>[...t[1]||(t[1]=[d("https://github.com/losehu/uv-k5-bootloader-custom/releases",-1)])]),_:1}),t[2]||(t[2]=d("\u3011",-1))])]),d(" "+g(e.$t("bl"))+" "+g(e.$t("global.onStart")),1)]),default:i(()=>[c(F,{style:{"margin-bottom":"16px"}},{default:i(()=>[c(p,{span:12},{default:i(()=>[c(u,{style:{width:"130%"}},{default:i(()=>[c(n,{onClick:P},{icon:i(()=>[c(s)]),default:i(()=>[d(" "+g(e.$t("cps.onDeviceWrite")),1)]),_:1}),d(" \uFF08"+g(e.$t("bl.onlyEnglish"))+"\uFF09 ",1)]),_:1})]),_:1})]),_:1}),m("div",Fe,[t[3]||(t[3]=m("div",null,"EEPROM\uFF1A",-1)),m("div",null,[d(g(o.showAdd)+" ",1),c(I,{size:"small",variant:"outline",onClick:t[0]||(t[0]=l=>E(256))},{default:i(()=>[d(g(e.$t("bl.clear")),1)]),_:1})])]),m("div",ve,[m("div",ke,[(y(!0),v(B,null,S(o.calendar,(l,_)=>(y(),v("div",{onClick:b=>A(_),ondragover:b=>{U(_),b.preventDefault()},ondrop:()=>{T(l,_)},title:l==-2?e.$t("bl.bootloader"):l!=-1?o.rom[l].binaryName:(_*64+262144).toString(16).toUpperCase()+" - "+(_*64+262144+63).toString(16).toUpperCase(),style:N(l==-1?"background-color: white; border: 1px solid #ddd; height: 10px;":l==-2?"background-color: #373737; border: 1px solid #ddd; height: 10px;":"background-color: "+o.rom[l].color+"; border: 1px solid #ddd; height: 10px;"),key:_}," \xA0 ",12,Ae))),128))])]),c(n,{style:{"margin-bottom":"10px"},onClick:L},{default:i(()=>[d(g(o.binaryFile?o.binaryName:e.$t("tool.selectFirmware")),1)]),_:1}),d("\uFF08"+g(e.$t("bl.drag"))+"\uFF09 ",1),t[4]||(t[4]=m("br",null,null,-1)),c(H,{"break-line":""},{default:i(()=>[(y(!0),v(B,null,S(o.rom,(l,_)=>(y(),fe(O,{draggable:"true",ondragstart:()=>{o.nowDrag=_},title:l.binaryName,bordered:!0,"hover-shadow":"",style:{width:"400px"}},{actions:i(()=>[m("div",{style:N("width: 10px; height: 10px; background-color: "+l.color+";")},null,4)]),default:i(()=>[c(z,{modelValue:l.binaryName,"onUpdate:modelValue":b=>l.binaryName=b,onChange:b=>R(_),"show-limit-number":"",maxlength:13},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["ondragstart","title"]))),256))]),_:1})]),_:1},8,["loading"]),m("div",{id:"statusArea",style:{height:"20em","background-color":"var(--color-bg-3)",color:"var(--color-text-3)",overflow:"auto",padding:"20px","margin-top":"10px"},innerHTML:o.status},null,8,Ee)])}}});const rt=K(Ce,[["__scopeId","data-v-7f8ac41e"]]);export{rt as default};
